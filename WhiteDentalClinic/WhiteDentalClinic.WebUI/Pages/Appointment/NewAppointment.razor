@attribute [Route(Routes.NewAppointment)]
@inject HttpClient Http
@using Syncfusion.Blazor.Calendars
@using System.ComponentModel.DataAnnotations
@using System.Text.Json
@using WhiteDentalClinic.Shared.Models
@using static WhiteDentalClinic.WebUI.Pages.Dentist.Dentists;


<h2>Make an appointment:</h2><br />
<h5>Select date and time for your appointment:</h5>
<br />
@*Add Placeholder="Choose a Date Range" in below code when no value is set to DateTimePicker*@



<EditForm class="d-flex flex-column align-items-left" Model="@newAppointment" OnSubmit="@HandleValidSubmit">

    <Syncfusion.Blazor.Calendars.SfDateTimePicker TValue="DateTime?" Min='@MinDate' Max='@MaxDate' @bind-Value='@newAppointment.dateTime'
                                                  StrictMode=true Placeholder="Select a date and time">
    </Syncfusion.Blazor.Calendars.SfDateTimePicker>

    <div class="m-2">
        <label for="id" class="col-sm-2 col-form-label">Dentist: </label>
        <div class="col-sm-10">
            <InputSelect class="form-select" id="id" @bind-Value="@newAppointment.DentistId">
                @foreach (var dentist in dentists)
                {
                    <option value="@dentist.Id">@dentist.FirstName @dentist.LastName</option>
                }
            </InputSelect>
        </div>
    </div>

    <button type="submit" class="btn btn-primary">Create appointment</button>

</EditForm>

<h4> Your appointment is: @response</h4>

@code {
    private List<DentistResponseModel> dentists = new List<DentistResponseModel>();

    protected override async Task OnInitializedAsync()
    {
        var temp = await Http.GetFromJsonAsync<ApiResult<IEnumerable<DentistResponseModel>>>("api/Dentists/all");
        dentists = temp.Result.ToList();
    }

    private CreateAppointmentRequestModel newAppointment = new CreateAppointmentRequestModel
    {
            CustomerId = Guid.Parse("c210cc12-7484-41b9-96da-834d2faf3aa2") // by default an ID customer. Need to be current Id customer
    };

    private string response = string.Empty;

    public DateTime MinDate { get; set; } = new DateTime(DateTime.Now.Year, DateTime.Now.Month, DateTime.Today.AddDays(1).Day, 02, 00, 00);
    public DateTime MaxDate { get; set; } = new DateTime(DateTime.Today.AddYears(2).Year, DateTime.Now.Month, 25, 02, 00, 00);
    public DateTime? DateValue { get; set; } = new DateTime(DateTime.Now.Year, DateTime.Now.Month, 10);


    public class CreateAppointmentRequestModel
    {
    public Guid Id = Guid.NewGuid();
    [Required(ErrorMessage = "Please select again the date and time.")]
    public DateTime? dateTime { get; set; }
    public Guid CustomerId { get; set; } 
    public Guid DentistId { get; set; }
    }

    public async Task HandleValidSubmit()
    {
        var response = await Http.PostAsJsonAsync("/api/Appointment", newAppointment);

        this.response = await response.Content.ReadAsStringAsync();
    }
}